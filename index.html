<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”¬æœè¾¨è­˜ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
        }

        .header {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            color: #2d3436;
            text-align: center;
            padding: 1.5rem;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
            color: #00b894;
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            color: #636e72;
        }

        .main-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 20px;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto;
        }

        .left-panel {
            flex: 1;
            min-width: 400px;
            max-width: 600px;
        }

        .right-panel {
            flex: 1;
            min-width: 400px;
            max-width: 600px;
        }

        .detection-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .welcome-message {
            margin-bottom: 20px;
        }

        .ai-message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            animation: fadeInUp 0.5s ease-out;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b894, #00a085);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 15px 15px 15px 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 85%;
            line-height: 1.6;
        }

        .message-content p {
            margin: 0 0 10px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .chat-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #636e72;
            font-style: italic;
        }

        .loading-dots {
            display: flex;
            margin-right: 10px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00b894;
            margin: 0 2px;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                min-width: 100%;
                max-width: 100%;
            }
            
            .chat-section {
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .detection-section, .chat-section {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .message-content {
                max-width: 90%;
            }
        }

        .section-title {
            text-align: center;
            font-size: 1.5rem;
            color: #2d3436;
            margin-bottom: 20px;
            font-weight: bold;
        }

        #webcam-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #webcam-container canvas {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 100%;
            height: auto;
        }

        .upload-area {
            border: 3px dashed #00b894;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background-color: rgba(0, 184, 148, 0.1);
            border-color: #00a085;
        }

        .upload-area.dragover {
            background-color: rgba(0, 184, 148, 0.2);
            border-color: #00a085;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .button.start {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .button.stop {
            background: linear-gradient(135deg, #e17055, #d63031);
        }

        .button.upload {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .result-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #00b894;
        }

        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 16px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .confidence-high {
            color: #00b894;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .confidence-medium {
            color: #fdcb6e;
            font-weight: bold;
        }

        .confidence-low {
            color: #636e72;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ddd, #bbb);
            margin: 15px auto;
            position: relative;
            overflow: hidden;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .status-good {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .status-bad {
            background: linear-gradient(135deg, #e17055, #d63031);
        }

        .status-unripe {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .help-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 320px;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding: 20px;
            overflow-y: auto;
        }

        .help-panel.active {
            transform: translateX(0);
        }

        .help-panel h2 {
            margin: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid #00b894;
            color: #2d3436;
        }

        .help-panel .close-btn {
            display: block;
            margin-top: 20px;
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .help-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        #loadingStatus {
            text-align: center;
            margin-top: 20px;
            font-size: 16px;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
        }

        #fileInput {
            display: none;
        }

        .detection-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* æ¨¡å‹é¸æ“‡å™¨æ¨£å¼ */
        .model-selector-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .model-label {
            display: block;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .model-selector {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #00b894;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #2d3436;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-selector:hover {
            border-color: #00a085;
            box-shadow: 0 2px 8px rgba(0, 184, 148, 0.2);
        }

        .model-selector:focus {
            outline: none;
            border-color: #00a085;
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }

        .model-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 6px;
            font-size: 12px;
        }

        .model-description {
            color: #636e72;
            font-style: italic;
        }

        .model-cost {
            font-weight: bold;
            color: #00b894;
        }

        .model-cost.high {
            color: #e17055;
        }

        .model-cost.medium {
            color: #fdcb6e;
        }

        .model-cost.low {
            color: #00b894;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ è”¬æœè¾¨è­˜ç³»çµ± ğŸŒ</h1>
        <p>AI æ™ºèƒ½æª¢æ¸¬è”¬æœæ–°é®®åº¦ - æª¢æ¸¬è”¬æœæ˜¯å¦è…çˆ›æˆ–æœªæˆç†Ÿ</p>
    </div>

    <!-- æ“ä½œèªªæ˜æŒ‰éˆ• -->
    <div class="help-toggle">æ“ä½œèªªæ˜</div>

    <!-- æ“ä½œèªªæ˜é¢æ¿ -->
    <div class="help-panel" id="helpPanel">
        <h2>æ“ä½œèªªæ˜</h2>
        <p><strong>æ­¡è¿ä½¿ç”¨è”¬æœè¾¨è­˜ç³»çµ±ï¼</strong></p>
        <h3>åŠŸèƒ½ä»‹ç´¹ï¼š</h3>
        <ul>
            <li><strong>å³æ™‚æ”åƒé ­è¾¨è­˜ï¼š</strong>å•Ÿå‹•æ”åƒé ­é€²è¡Œå³æ™‚è”¬æœæª¢æ¸¬</li>
            <li><strong>åœ–ç‰‡ä¸Šå‚³è¾¨è­˜ï¼š</strong>ä¸Šå‚³åœ–ç‰‡é€²è¡Œè”¬æœç‹€æ…‹åˆ†æ</li>
        </ul>
        <h3>è¾¨è­˜é¡åˆ¥ï¼š</h3>
        <ul>
            <li>ğŸ è˜‹æœï¼ˆè‰¯å¥½/è…çˆ›/æœªæˆç†Ÿï¼‰</li>
            <li>ğŸŒ é¦™è•‰ï¼ˆè‰¯å¥½/è…çˆ›/æœªæˆç†Ÿï¼‰</li>
            <li>ğŸŠ æ©˜å­ï¼ˆè‰¯å¥½/è…çˆ›/æœªæˆç†Ÿï¼‰</li>
            <li>â“ å…¶ä»–ç‰©å“</li>
        </ul>
        <h3>ä½¿ç”¨æ–¹å¼ï¼š</h3>
        <ol>
            <li>é¸æ“‡ã€Œæ”åƒé ­è¾¨è­˜ã€æˆ–ã€Œåœ–ç‰‡ä¸Šå‚³ã€</li>
            <li>ç­‰å¾… AI åˆ†æçµæœ</li>
            <li>ä¿¡å¿ƒåº¦é”90%æ™‚æœƒç™¼å‡ºæç¤ºéŸ³</li>
        </ol>
        <div class="close-btn" onclick="toggleHelpPanel()">é—œé–‰</div>
    </div>

    <div class="main-container">
        <!-- å·¦å´ï¼šè¾¨è­˜åŠŸèƒ½å€å¡Š -->
        <div class="left-panel">
            <!-- æ”åƒé ­è¾¨è­˜å€å¡Š -->
            <div class="detection-section">
                <div class="section-title">ğŸ“¹ æ”åƒé ­è¾¨è­˜</div>
                <div id="webcam-container"></div>
                <div class="status-indicator" id="webcam-status"></div>
                <div class="controls">
                    <button id="startWebcamBtn" class="button start">é–‹å§‹æ”åƒé ­è¾¨è­˜</button>
                    <button id="stopWebcamBtn" class="button stop">åœæ­¢æ”åƒé ­è¾¨è­˜</button>
                </div>
                <div class="result-panel">
                    <div id="webcamResults">æ”åƒé ­è¾¨è­˜çµæœ: ç­‰å¾…é–‹å§‹...</div>
                </div>
            </div>

            <!-- åœ–ç‰‡ä¸Šå‚³è¾¨è­˜å€å¡Š -->
            <div class="detection-section">
                <div class="section-title">ğŸ“ åœ–ç‰‡ä¸Šå‚³è¾¨è­˜</div>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div>ğŸ“¸ é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•</div>
                    <div style="font-size: 14px; color: #636e72; margin-top: 10px;">
                        æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ - ä¸Šå‚³å¾Œè‡ªå‹•åˆ†æ
                    </div>
                    <img id="imagePreview" style="display: none;" />
                </div>
                <input type="file" id="fileInput" accept="image/*" />
                <div class="status-indicator" id="upload-status"></div>
                <div class="controls">
                    <button id="analyzeBtn" class="button upload" disabled style="display: none;">åˆ†æåœ–ç‰‡</button>
                    <button id="clearBtn" class="button stop">æ¸…é™¤åœ–ç‰‡</button>
                </div>
                <div class="result-panel">
                    <div id="uploadResults">åœ–ç‰‡è¾¨è­˜çµæœ: ç­‰å¾…ä¸Šå‚³...</div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šAI å»ºè­°å°è©±å€å¡Š -->
        <div class="right-panel">
            <div class="chat-section">
                <div class="section-title">ğŸ¤– AI æ™ºèƒ½å»ºè­°</div>
                
                <!-- æ¨¡å‹é¸æ“‡å€å¡Š -->
                <div class="model-selector-container">
                    <label for="modelSelector" class="model-label">ğŸ”§ é¸æ“‡ AI æ¨¡å‹ï¼š</label>
                    <select id="modelSelector" class="model-selector">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (å¿«é€Ÿã€ç¶“æ¿Ÿ)</option>
                        <option value="gpt-4">GPT-4 (é«˜å“è³ªã€è¼ƒæ…¢)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo (å¹³è¡¡é¸æ“‡)</option>
                        <option value="gpt-4o">GPT-4o (æœ€æ–°æ¨¡å‹)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (è¼•é‡ç‰ˆ)</option>
                    </select>
                    <div class="model-info" id="modelInfo">
                        <span class="model-description">å¿«é€Ÿå›æ‡‰ï¼Œé©åˆä¸€èˆ¬å»ºè­°</span>
                        <span class="model-cost">ğŸ’° ä½æˆæœ¬</span>
                    </div>
                </div>
                <div class="chat-container" id="chatContainer">
                    <div class="welcome-message">
                        <div class="ai-message">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message-content">
                                <p>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è”¬æœå°ˆå®¶åŠ©æ‰‹ã€‚</p>
                                <p>ç•¶æ‚¨å®Œæˆè”¬æœè¾¨è­˜å¾Œï¼Œæˆ‘æœƒæ ¹æ“šè¾¨è­˜çµæœç‚ºæ‚¨æä¾›ï¼š</p>
                                <ul>
                                    <li>ğŸ è™•ç†å’Œä¿å­˜å»ºè­°</li>
                                    <li>ğŸ¥— é£Ÿç”¨å’Œæ–™ç†æ–¹æ³•</li>
                                    <li>ğŸ“š ç‡Ÿé¤Šåƒ¹å€¼ç§‘æ™®</li>
                                    <li>âš ï¸ æ³¨æ„äº‹é …æé†’</li>
                                </ul>
                                <p>è«‹é–‹å§‹è¾¨è­˜æ‚¨çš„è”¬æœå§ï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-loading" id="chatLoading" style="display: none;">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>AI æ­£åœ¨åˆ†æä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- è¾¨è­˜èªªæ˜ -->
    <div style="max-width: 800px; margin: 20px auto; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px;">
        <h3 style="text-align: center; color: #2d3436;">è¾¨è­˜ç‹€æ…‹èªªæ˜</h3>
        <div class="detection-legend">
            <div class="legend-item">
                <div class="legend-color status-good"></div>
                <span>è‰¯å¥½ç‹€æ…‹</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-bad"></div>
                <span>è…çˆ›ç‹€æ…‹</span>
            </div>
            <div class="legend-item">
                <div class="legend-color status-unripe"></div>
                <span>æœªæˆç†Ÿç‹€æ…‹</span>
            </div>
        </div>
    </div>

    <div id="loadingStatus">
        <p>ğŸ¤– AI æ¨¡å‹åŠ è¼‰ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>

    <script>
        // æ“ä½œèªªæ˜é¢æ¿é–‹é—œ
        const helpPanel = document.getElementById('helpPanel');
        const helpToggle = document.querySelector('.help-toggle');

        function toggleHelpPanel() {
            helpPanel.classList.toggle('active');
        }

        helpToggle.addEventListener('click', toggleHelpPanel);

        // AI æ¨¡å‹ç›¸é—œè®Šæ•¸
        const URL = "https://teachablemachine.withgoogle.com/models/95JhNZvMx/";
        let model, webcam, maxPredictions;
        let isWebcamDetecting = false;

        // API è¨­å®š - ç›´æ¥ä½¿ç”¨ HTML æ–‡ä»¶æ¨¡å¼
        const API_CONFIG = {
            // æ–¹æ³•1: ä½¿ç”¨æœ¬åœ°ä»£ç†æœå‹™å™¨ï¼ˆæ¨è–¦ï¼‰
            useProxy: false,  // æ”¹ç‚º falseï¼Œç›´æ¥ä½¿ç”¨ HTML
            proxyUrl: '/api/chat',
            
            // æ–¹æ³•2: ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–å¤–éƒ¨é…ç½®
            openaiApiKey: window.OPENAI_API_KEY || localStorage.getItem('openai_api_key') || '',
            openaiApiUrl: 'https://api.openai.com/v1/chat/completions',
            
            // æ–¹æ³•3: ä½¿ç”¨ Vercel/Netlify Functions
            useServerless: false,
            serverlessUrl: '/api/chat-function'
        };

        // è”¬æœåˆ†é¡å°æ‡‰
        const fruitCategories = {
            good: ['è‰¯å¥½çš„è˜‹æœ', 'è‰¯å¥½çš„é¦™è•‰', 'è‰¯å¥½çš„æ©˜å­'],
            rotten: ['è…çˆ›çš„è˜‹æœ', 'è…çˆ›çš„é¦™è•‰', 'è…çˆ›çš„æ©˜å­'],
            unripe: ['æœªæˆç†Ÿçš„è˜‹æœ', 'æœªæˆç†Ÿçš„é¦™è•‰', 'æœªæˆç†Ÿçš„æ©˜å­'],
            other: ['å…¶ä»–']
        };

        // æ¨¡å‹é¸æ“‡å™¨åŠŸèƒ½
        const modelSelector = document.getElementById('modelSelector');
        const modelInfo = document.getElementById('modelInfo');
        
        // æ¨¡å‹è³‡è¨Šé…ç½®
        const modelConfigs = {
            'gpt-3.5-turbo': {
                description: 'å¿«é€Ÿå›æ‡‰ï¼Œé©åˆä¸€èˆ¬å»ºè­°',
                cost: 'ğŸ’° ä½æˆæœ¬',
                costClass: 'low'
            },
            'gpt-4': {
                description: 'é«˜å“è³ªå›æ‡‰ï¼Œæ›´è©³ç´°å°ˆæ¥­',
                cost: 'ğŸ’°ğŸ’°ğŸ’° é«˜æˆæœ¬',
                costClass: 'high'
            },
            'gpt-4-turbo': {
                description: 'å¹³è¡¡é€Ÿåº¦èˆ‡å“è³ª',
                cost: 'ğŸ’°ğŸ’° ä¸­ç­‰æˆæœ¬',
                costClass: 'medium'
            },
            'gpt-4o': {
                description: 'æœ€æ–°æ¨¡å‹ï¼ŒåŠŸèƒ½æœ€å¼·',
                cost: 'ğŸ’°ğŸ’° ä¸­ç­‰æˆæœ¬',
                costClass: 'medium'
            },
            'gpt-4o-mini': {
                description: 'è¼•é‡ç‰ˆï¼Œå¿«é€Ÿä¸”ç¶“æ¿Ÿ',
                cost: 'ğŸ’° ä½æˆæœ¬',
                costClass: 'low'
            }
        };

        // åˆå§‹åŒ–æ¨¡å‹é¸æ“‡å™¨
        function initializeModelSelector() {
            // å¾ localStorage è¼‰å…¥ä¿å­˜çš„æ¨¡å‹é¸æ“‡
            const savedModel = localStorage.getItem('selected_model') || 'gpt-3.5-turbo';
            modelSelector.value = savedModel;
            updateModelInfo(savedModel);
            
            // ç¶å®šé¸æ“‡è®Šæ›´äº‹ä»¶
            modelSelector.addEventListener('change', function() {
                const selectedModel = this.value;
                updateModelInfo(selectedModel);
                // ä¿å­˜é¸æ“‡åˆ° localStorage
                localStorage.setItem('selected_model', selectedModel);
                
                // é¡¯ç¤ºæ¨¡å‹åˆ‡æ›æç¤º
                addAIMessage(`ğŸ”„ å·²åˆ‡æ›åˆ° ${modelConfigs[selectedModel].description} æ¨¡å‹ã€‚ä¸‹æ¬¡è¾¨è­˜æ™‚å°‡ä½¿ç”¨æ–°æ¨¡å‹ã€‚`);
            });
        }

        // æ›´æ–°æ¨¡å‹è³‡è¨Šé¡¯ç¤º
        function updateModelInfo(modelKey) {
            const config = modelConfigs[modelKey];
            if (config) {
                const descriptionSpan = modelInfo.querySelector('.model-description');
                const costSpan = modelInfo.querySelector('.model-cost');
                
                descriptionSpan.textContent = config.description;
                costSpan.textContent = config.cost;
                costSpan.className = `model-cost ${config.costClass}`;
            }
        }

        // ç²å–ç•¶å‰é¸ä¸­çš„æ¨¡å‹
        function getCurrentModel() {
            return modelSelector.value || 'gpt-3.5-turbo';
        }

        // ChatGPT å°è©±åŠŸèƒ½ - æ”¯æ´å¤šç¨®å®‰å…¨èª¿ç”¨æ–¹å¼
        async function getChatGPTAdvice(fruitResult, confidence) {
            const chatLoading = document.getElementById('chatLoading');
            const chatContainer = document.getElementById('chatContainer');
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            chatLoading.style.display = 'flex';
            
            try {
                let response;
                let advice;

                if (API_CONFIG.useProxy) {
                    // æ–¹æ³•1: ä½¿ç”¨æœ¬åœ°ä»£ç†æœå‹™å™¨ï¼ˆæ¨è–¦ï¼‰
                    response = await fetch(API_CONFIG.proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fruitResult: fruitResult,
                            confidence: confidence
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`ä»£ç†æœå‹™å™¨éŒ¯èª¤: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {
                        advice = data.advice;
                    } else {
                        throw new Error(data.error || 'ä»£ç†æœå‹™å™¨å›æ‡‰éŒ¯èª¤');
                    }

                } else if (API_CONFIG.useServerless) {
                    // æ–¹æ³•3: ä½¿ç”¨ Serverless Functions
                    response = await fetch(API_CONFIG.serverlessUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fruitResult: fruitResult,
                            confidence: confidence
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Serverless å‡½æ•¸éŒ¯èª¤: ${response.status}`);
                    }

                    const data = await response.json();
                    advice = data.advice || data.message;

                } else if (API_CONFIG.openaiApiKey) {
                    // æ–¹æ³•2: ç›´æ¥èª¿ç”¨ OpenAI APIï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰
                    console.warn('âš ï¸ è­¦å‘Šï¼šæ­£åœ¨ä½¿ç”¨ç›´æ¥ API èª¿ç”¨ï¼Œé€™åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä¸å®‰å…¨ï¼');
                    
                    const prompt = `æˆ‘å‰›å‰›ç”¨AIè¾¨è­˜äº†ä¸€å€‹è”¬æœï¼Œçµæœæ˜¯ã€Œ${fruitResult}ã€ï¼Œä¿¡å¿ƒåº¦ç‚º${confidence}%ã€‚

è«‹ä»¥å°ˆæ¥­è”¬æœå°ˆå®¶çš„èº«ä»½ï¼Œç”¨ç¹é«”ä¸­æ–‡ç‚ºæˆ‘æä¾›ä»¥ä¸‹å»ºè­°ï¼š

1. ğŸ **è™•ç†å’Œä¿å­˜å»ºè­°**ï¼šæ ¹æ“šé€™å€‹è”¬æœçš„ç‹€æ…‹ï¼Œæˆ‘æ‡‰è©²å¦‚ä½•è™•ç†å’Œä¿å­˜ï¼Ÿ
2. ğŸ¥— **é£Ÿç”¨å’Œæ–™ç†æ–¹æ³•**ï¼šæ¨è–¦é©åˆçš„é£Ÿç”¨æ–¹å¼æˆ–æ–™ç†æ–¹æ³•
3. ğŸ“š **ç‡Ÿé¤Šåƒ¹å€¼ç§‘æ™®**ï¼šé€™å€‹è”¬æœçš„ç‡Ÿé¤Šæˆåˆ†å’Œå¥åº·ç›Šè™•
4. âš ï¸ **æ³¨æ„äº‹é …æé†’**ï¼šæœ‰ä»€éº¼éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹ï¼Ÿ

è«‹ç”¨è¦ªåˆ‡ã€å°ˆæ¥­çš„èªèª¿å›ç­”ï¼Œä¸¦ä½¿ç”¨é©ç•¶çš„è¡¨æƒ…ç¬¦è™Ÿè®“å›ç­”æ›´ç”Ÿå‹•ã€‚å›ç­”è¦å¯¦ç”¨ä¸”å…·é«”ã€‚`;

                    response = await fetch(API_CONFIG.openaiApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.openaiApiKey}`
                        },
                        body: JSON.stringify({
                            model: getCurrentModel(),
                            messages: [
                                {
                                    role: "system",
                                    content: "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è”¬æœå°ˆå®¶ï¼Œæ“…é•·æä¾›è”¬æœè™•ç†ã€ä¿å­˜ã€ç‡Ÿé¤Šå’Œæ–™ç†å»ºè­°ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªèª¿è¦è¦ªåˆ‡å°ˆæ¥­ã€‚"
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OpenAI API éŒ¯èª¤: ${response.status}`);
                    }

                    const data = await response.json();
                    advice = data.choices[0].message.content;

                } else {
                    // æ²’æœ‰é…ç½®ä»»ä½• APIï¼Œé¡¯ç¤ºæ¨¡æ“¬å›æ‡‰
                    advice = generateMockAdvice(fruitResult, confidence);
                }

                // éš±è—è¼‰å…¥å‹•ç•«
                chatLoading.style.display = 'none';

                // æ·»åŠ  AI å›æ‡‰åˆ°å°è©±å®¹å™¨
                addAIMessage(advice);

            } catch (error) {
                console.error('ChatGPT API éŒ¯èª¤:', error);
                chatLoading.style.display = 'none';
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯å’Œå‚™ç”¨å»ºè­°
                const fallbackAdvice = generateMockAdvice(fruitResult, confidence);
                addAIMessage(`âš ï¸ AI å»ºè­°æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œä»¥ä¸‹æ˜¯åŸºæœ¬å»ºè­°ï¼š\n\n${fallbackAdvice}\n\nå¦‚éœ€å®Œæ•´ AI å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`);
            }
        }

        // ç”Ÿæˆæ¨¡æ“¬å»ºè­°ï¼ˆç•¶ API ä¸å¯ç”¨æ™‚ï¼‰
        function generateMockAdvice(fruitResult, confidence) {
            const fruitType = fruitResult.includes('è˜‹æœ') ? 'è˜‹æœ' : 
                             fruitResult.includes('é¦™è•‰') ? 'é¦™è•‰' : 
                             fruitResult.includes('æ©˜å­') ? 'æ©˜å­' : 'è”¬æœ';
            
            const condition = fruitResult.includes('è‰¯å¥½') ? 'è‰¯å¥½' : 
                             fruitResult.includes('è…çˆ›') ? 'è…çˆ›' : 
                             fruitResult.includes('æœªæˆç†Ÿ') ? 'æœªæˆç†Ÿ' : 'æœªçŸ¥';

            let advice = `æ ¹æ“šè¾¨è­˜çµæœã€Œ${fruitResult}ã€ï¼ˆä¿¡å¿ƒåº¦ ${confidence}%ï¼‰ï¼Œä»¥ä¸‹æ˜¯å°ˆæ¥­å»ºè­°ï¼š\n\n`;

            // æ ¹æ“šä¸åŒç‹€æ…‹æä¾›å®Œæ•´å»ºè­°
            if (condition === 'è‰¯å¥½') {
                advice += `ğŸ **è™•ç†å’Œä¿å­˜å»ºè­°**ï¼š\n`;
                if (fruitType === 'è˜‹æœ') {
                    advice += `â€¢ å¯ä»¥ç›´æ¥é£Ÿç”¨ï¼Œç‡Ÿé¤Šåƒ¹å€¼æœ€ä½³\n`;
                    advice += `â€¢ å­˜æ”¾åœ¨å†°ç®±å†·è—å®¤å¯ä¿å­˜ 1-2 é€±\n`;
                    advice += `â€¢ å®¤æº«ä¸‹å¯ä¿å­˜ 3-5 å¤©\n`;
                    advice += `â€¢ é¿å…èˆ‡é¦™è•‰ç­‰å‚¬ç†Ÿæ°´æœä¸€èµ·å­˜æ”¾\n\n`;
                } else if (fruitType === 'é¦™è•‰') {
                    advice += `â€¢ å®¤æº«ä¿å­˜ï¼Œé¿å…å†·è—\n`;
                    advice += `â€¢ å¯æ‡¸æ›ä¿å­˜ï¼Œæ¸›å°‘æ¥è§¸é¢ç©\n`;
                    advice += `â€¢ å»ºè­° 2-3 å¤©å…§é£Ÿç”¨å®Œç•¢\n`;
                    advice += `â€¢ å¦‚è¦å»¶é•·ä¿å­˜ï¼Œå¯åˆ†é–‹å­˜æ”¾\n\n`;
                } else if (fruitType === 'æ©˜å­') {
                    advice += `â€¢ å®¤æº«ä¸‹å¯ä¿å­˜ 1 é€±\n`;
                    advice += `â€¢ å†·è—å¯å»¶é•·è‡³ 2-3 é€±\n`;
                    advice += `â€¢ ä¿æŒé€šé¢¨ï¼Œé¿å…æ½®æ¿•\n`;
                    advice += `â€¢ ç™¼ç¾è»Ÿçˆ›æ‡‰ç«‹å³é£Ÿç”¨æˆ–ä¸Ÿæ£„\n\n`;
                }
                
                advice += `ğŸ¥— **é£Ÿç”¨å’Œæ–™ç†æ–¹æ³•**ï¼š\n`;
                if (fruitType === 'è˜‹æœ') {
                    advice += `â€¢ ç›´æ¥é£Ÿç”¨ï¼Œä¿ç•™æœçš®ç‡Ÿé¤Šæ›´è±å¯Œ\n`;
                    advice += `â€¢ è£½ä½œè˜‹æœæ±ã€è˜‹æœæ´¾æˆ–æ²™æ‹‰\n`;
                    advice += `â€¢ å¯åˆ‡ç‰‡æ­é…èŠ±ç”Ÿé†¬æˆ–å„ªæ ¼\n`;
                    advice += `â€¢ çƒ˜çƒ¤è£½ä½œå¥åº·é›¶é£Ÿ\n\n`;
                } else if (fruitType === 'é¦™è•‰') {
                    advice += `â€¢ ç›´æ¥å‰çš®é£Ÿç”¨ï¼Œæ–¹ä¾¿å¿«é€Ÿ\n`;
                    advice += `â€¢ è£½ä½œé¦™è•‰å¥¶æ˜”æˆ–æœæ±\n`;
                    advice += `â€¢ åˆ‡ç‰‡åŠ å…¥ç‡•éº¥æˆ–å„ªæ ¼\n`;
                    advice += `â€¢ çƒ˜ç„™é¦™è•‰éºµåŒ…æˆ–é¦¬èŠ¬\n\n`;
                } else if (fruitType === 'æ©˜å­') {
                    advice += `â€¢ å‰çš®ç›´æ¥é£Ÿç”¨ï¼Œè£œå……ç¶­ç”Ÿç´  C\n`;
                    advice += `â€¢ æ¦¨æ±é£²ç”¨ï¼Œä½†å»ºè­°é€£æœè‚‰ä¸€èµ·\n`;
                    advice += `â€¢ è£½ä½œæ°´æœæ²™æ‹‰æˆ–ç”œé»\n`;
                    advice += `â€¢ æ©˜çš®å¯è£½ä½œé™³çš®æˆ–èª¿å‘³æ–™\n\n`;
                }

                advice += `ğŸ“š **ç‡Ÿé¤Šåƒ¹å€¼ç§‘æ™®**ï¼š\n`;
                if (fruitType === 'è˜‹æœ') {
                    advice += `â€¢ å¯Œå«è†³é£Ÿçº–ç¶­ï¼Œæœ‰åŠ©æ¶ˆåŒ–å¥åº·\n`;
                    advice += `â€¢ å«æœ‰ç¶­ç”Ÿç´  C å’ŒæŠ—æ°§åŒ–ç‰©è³ª\n`;
                    advice += `â€¢ æœè† æœ‰åŠ©é™ä½è†½å›ºé†‡\n`;
                    advice += `â€¢ ä½ç†±é‡ï¼Œé©åˆé«”é‡ç®¡ç†\n\n`;
                } else if (fruitType === 'é¦™è•‰') {
                    advice += `â€¢ é«˜é‰€å«é‡ï¼Œæœ‰ç›Šå¿ƒè¡€ç®¡å¥åº·\n`;
                    advice += `â€¢ å«ç¶­ç”Ÿç´  B6ï¼Œæ”¯æŒç¥ç¶“åŠŸèƒ½\n`;
                    advice += `â€¢ å¤©ç„¶ç³–åˆ†ï¼Œå¿«é€Ÿè£œå……èƒ½é‡\n`;
                    advice += `â€¢ è†³é£Ÿçº–ç¶­ä¿ƒé€²è…¸é“å¥åº·\n\n`;
                } else if (fruitType === 'æ©˜å­') {
                    advice += `â€¢ ç¶­ç”Ÿç´  C å«é‡æ¥µé«˜ï¼Œå¢å¼·å…ç–«åŠ›\n`;
                    advice += `â€¢ å«è‘‰é…¸ï¼Œå°å­•å©¦ç‰¹åˆ¥æœ‰ç›Š\n`;
                    advice += `â€¢ é¡é»ƒé…®å…·æŠ—ç‚ä½œç”¨\n`;
                    advice += `â€¢ ä½ç†±é‡é«˜çº–ç¶­ï¼Œæœ‰åŠ©æ¸›é‡\n\n`;
                }

                advice += `âš ï¸ **æ³¨æ„äº‹é …æé†’**ï¼š\n`;
                advice += `â€¢ é£Ÿç”¨å‰è«‹æ¸…æ´—ä¹¾æ·¨\n`;
                advice += `â€¢ ç³–å°¿ç—…æ‚£è€…æ‡‰é©é‡é£Ÿç”¨\n`;
                advice += `â€¢ éæ•é«”è³ªè€…é¦–æ¬¡é£Ÿç”¨è«‹æ³¨æ„åæ‡‰\n`;
                advice += `â€¢ å»ºè­°ä½œç‚ºå‡è¡¡é£²é£Ÿçš„ä¸€éƒ¨åˆ†\n\n`;

            } else if (condition === 'è…çˆ›') {
                advice += `âš ï¸ **é‡è¦å®‰å…¨æé†’**ï¼š\n`;
                advice += `â€¢ å¼·çƒˆå»ºè­°ä¸è¦é£Ÿç”¨è…çˆ›çš„è”¬æœ\n`;
                advice += `â€¢ å¯èƒ½å«æœ‰æœ‰å®³ç´°èŒã€é»´èŒæˆ–æ¯’ç´ \n`;
                advice += `â€¢ é£Ÿç”¨å¾Œå¯èƒ½å¼•èµ·è…¸èƒƒä¸é©æˆ–é£Ÿç‰©ä¸­æ¯’\n`;
                advice += `â€¢ è«‹ç«‹å³ä¸Ÿæ£„ï¼Œé¿å…æ±¡æŸ“å…¶ä»–é£Ÿç‰©\n\n`;

                advice += `ğŸ—‘ï¸ **æ­£ç¢ºè™•ç†æ–¹æ³•**ï¼š\n`;
                advice += `â€¢ ç”¨å¡‘è† è¢‹åŒ…è£å¾Œä¸Ÿå…¥åƒåœ¾æ¡¶\n`;
                advice += `â€¢ æ¸…æ½”æ¥è§¸éçš„è¡¨é¢å’Œå®¹å™¨\n`;
                advice += `â€¢ æª¢æŸ¥é™„è¿‘å…¶ä»–æ°´æœæ˜¯å¦å—å½±éŸ¿\n`;
                advice += `â€¢ å¾¹åº•æ´—æ‰‹ï¼Œé¿å…äº¤å‰æ±¡æŸ“\n\n`;

                advice += `ğŸ” **é é˜²è…çˆ›å°è²¼å£«**ï¼š\n`;
                advice += `â€¢ è³¼è²·æ™‚é¸æ“‡æ–°é®®ã€ç„¡æå‚·çš„æ°´æœ\n`;
                advice += `â€¢ é©ç•¶çš„æº«åº¦å’Œæ¿•åº¦ä¿å­˜\n`;
                advice += `â€¢ å®šæœŸæª¢æŸ¥ï¼ŒåŠæ™‚è™•ç†è®Šè³ªæ°´æœ\n`;
                advice += `â€¢ é¿å…éåº¦å †ç–Šé€ æˆå£“å‚·\n\n`;

                advice += `ğŸ“š **å¥åº·çŸ¥è­˜**ï¼š\n`;
                advice += `â€¢ è…çˆ›æ˜¯å¾®ç”Ÿç‰©åˆ†è§£æœ‰æ©Ÿç‰©çš„è‡ªç„¶éç¨‹\n`;
                advice += `â€¢ é»´èŒæ¯’ç´ å°äººé«”æœ‰å®³ï¼Œä¸å¯å¿½è¦–\n`;
                advice += `â€¢ å³ä½¿åˆ‡é™¤è…çˆ›éƒ¨åˆ†ï¼Œæ¯’ç´ å¯èƒ½å·²æ“´æ•£\n`;
                advice += `â€¢ é¸æ“‡æ–°é®®é£Ÿææ˜¯å¥åº·é£²é£Ÿçš„åŸºç¤\n\n`;

            } else if (condition === 'æœªæˆç†Ÿ') {
                advice += `ğŸ **å‚¬ç†Ÿå’Œä¿å­˜å»ºè­°**ï¼š\n`;
                if (fruitType === 'è˜‹æœ') {
                    advice += `â€¢ æ”¾ç½®å®¤æº«ä¸‹è‡ªç„¶ç†Ÿæˆ 3-5 å¤©\n`;
                    advice += `â€¢ èˆ‡æˆç†Ÿè˜‹æœæˆ–é¦™è•‰ä¸€èµ·å­˜æ”¾åŠ é€Ÿç†Ÿæˆ\n`;
                    advice += `â€¢ é¿å…å†·è—ï¼Œæœƒé˜»ç¤™ç†Ÿæˆéç¨‹\n`;
                    advice += `â€¢ ç†Ÿæˆå¾Œæœè‚‰æœƒè®Šè»Ÿï¼Œç”œåº¦å¢åŠ \n\n`;
                } else if (fruitType === 'é¦™è•‰') {
                    advice += `â€¢ å®¤æº«ä¸‹ 2-4 å¤©å³å¯å®Œå…¨ç†Ÿæˆ\n`;
                    advice += `â€¢ å¯ç”¨ç´™è¢‹åŒ…è£åŠ é€Ÿç†Ÿæˆ\n`;
                    advice += `â€¢ é¿å…é™½å…‰ç›´å°„å’Œä½æº«ç’°å¢ƒ\n`;
                    advice += `â€¢ ç†Ÿæˆæ¨™èªŒï¼šæœçš®è®Šé»ƒï¼Œå‡ºç¾é»‘é»\n\n`;
                } else if (fruitType === 'æ©˜å­') {
                    advice += `â€¢ å®¤æº«ä¸‹ç¹¼çºŒç†Ÿæˆ 1-2 é€±\n`;
                    advice += `â€¢ èˆ‡è˜‹æœä¸€èµ·å­˜æ”¾å¯åŠ é€Ÿç†Ÿæˆ\n`;
                    advice += `â€¢ ä¿æŒé©ç•¶æ¿•åº¦ï¼Œé¿å…éåº¦ä¹¾ç‡¥\n`;
                    advice += `â€¢ ç†Ÿæˆå¾Œæœçš®æœƒè®Šè»Ÿï¼Œæ›´æ˜“å‰é›¢\n\n`;
                }

                advice += `ğŸ¥— **æœªæˆç†Ÿæ™‚çš„é£Ÿç”¨å»ºè­°**ï¼š\n`;
                if (fruitType === 'è˜‹æœ') {
                    advice += `â€¢ å¯ä»¥é£Ÿç”¨ï¼Œä½†å£æ„Ÿè¼ƒç¡¬ã€é…¸æ¾€\n`;
                    advice += `â€¢ é©åˆè£½ä½œè˜‹æœé†‹æˆ–æ–™ç†ç”¨é€”\n`;
                    advice += `â€¢ ç‡Ÿé¤Šåƒ¹å€¼ç•¥ä½æ–¼æˆç†Ÿè˜‹æœ\n`;
                    advice += `â€¢ å»ºè­°ç­‰å¾…ç†Ÿæˆå¾Œé£Ÿç”¨å£æ„Ÿæ›´ä½³\n\n`;
                } else if (fruitType === 'é¦™è•‰') {
                    advice += `â€¢ æœªç†Ÿé¦™è•‰è¼ƒç¡¬ï¼Œæ¾±ç²‰å«é‡é«˜\n`;
                    advice += `â€¢ å¯ä»¥ç…®é£Ÿï¼Œå¦‚é¦™è•‰ç…é¤…æˆ–æ¹¯å“\n`;
                    advice += `â€¢ ç”Ÿé£Ÿå¯èƒ½è¼ƒé›£æ¶ˆåŒ–\n`;
                    advice += `â€¢ å»ºè­°ç­‰åˆ°æœçš®è®Šé»ƒå¾Œé£Ÿç”¨\n\n`;
                } else if (fruitType === 'æ©˜å­') {
                    advice += `â€¢ å¯ä»¥é£Ÿç”¨ï¼Œä½†è¼ƒé…¸æ¾€\n`;
                    advice += `â€¢ ç¶­ç”Ÿç´  C å«é‡ä»ç„¶è±å¯Œ\n`;
                    advice += `â€¢ å¯è£½ä½œæœé†¬æˆ–èª¿å‘³æ–™\n`;
                    advice += `â€¢ ç†Ÿæˆå¾Œç”œåº¦å’Œå£æ„Ÿæœƒå¤§å¹…æ”¹å–„\n\n`;
                }

                advice += `ğŸ“š **ç‡Ÿé¤Šåƒ¹å€¼**ï¼š\n`;
                advice += `â€¢ ${fruitType}å³ä½¿æœªå®Œå…¨ç†Ÿæˆä»å«è±å¯Œç‡Ÿé¤Š\n`;
                advice += `â€¢ ç¶­ç”Ÿç´ å’Œç¤¦ç‰©è³ªå«é‡åŸºæœ¬ä¸è®Š\n`;
                advice += `â€¢ ç†Ÿæˆéç¨‹ä¸­æ¾±ç²‰è½‰åŒ–ç‚ºç³–åˆ†\n`;
                advice += `â€¢ é©ç•¶ç­‰å¾…ç†Ÿæˆå¯ç²å¾—æœ€ä½³ç‡Ÿé¤Šå’Œå£æ„Ÿ\n\n`;

                advice += `âš ï¸ **æ³¨æ„äº‹é …**ï¼š\n`;
                advice += `â€¢ é¿å…é£Ÿç”¨éåº¦æœªç†Ÿçš„æ°´æœ\n`;
                advice += `â€¢ è…¸èƒƒæ•æ„Ÿè€…å»ºè­°ç­‰å¾…å®Œå…¨ç†Ÿæˆ\n`;
                advice += `â€¢ ç†Ÿæˆéç¨‹ä¸­å®šæœŸæª¢æŸ¥ï¼Œé¿å…éç†Ÿ\n`;
                advice += `â€¢ è€å¿ƒç­‰å¾…ï¼Œç¾å‘³å€¼å¾—æœŸå¾…\n\n`;
            }

            advice += `ğŸ’¡ **å°ˆæ¥­å°æç¤º**ï¼šé€™æ˜¯åŸºæ–¼æ°´æœç‰¹æ€§çš„åŸºæœ¬å»ºè­°ã€‚å¦‚éœ€æ›´è©³ç´°çš„å€‹äººåŒ–ç‡Ÿé¤Šå»ºè­°ï¼Œå»ºè­°è«®è©¢ç‡Ÿé¤Šå¸«æˆ–ç¢ºä¿ AI æœå‹™æ­£å¸¸é‹ä½œä»¥ç²å¾—æ›´å°ˆæ¥­çš„åˆ†æã€‚`;

            return advice;
        }

        // æ·»åŠ  AI è¨Šæ¯åˆ°å°è©±å®¹å™¨
        function addAIMessage(content) {
            const chatContainer = document.getElementById('chatContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    ${formatMessageContent(content)}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            // æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ ¼å¼åŒ–è¨Šæ¯å…§å®¹
        function formatMessageContent(content) {
            // å°‡æ›è¡Œç¬¦è™Ÿè½‰æ›ç‚º <br>
            let formatted = content.replace(/\n/g, '<br>');
            
            // å°‡ **æ–‡å­—** è½‰æ›ç‚ºç²—é«”
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // å°‡æ•¸å­—åˆ—è¡¨æ ¼å¼åŒ–
            formatted = formatted.replace(/^(\d+\.\s)/gm, '<br><strong>$1</strong>');
            
            return formatted;
        }

        // éŸ³æ•ˆæ’­æ”¾
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // å–å¾—ç‹€æ…‹æŒ‡ç¤ºå™¨é¡è‰²
        function getStatusClass(className) {
            if (fruitCategories.good.includes(className)) return 'status-good';
            if (fruitCategories.rotten.includes(className)) return 'status-bad';
            if (fruitCategories.unripe.includes(className)) return 'status-unripe';
            return '';
        }

        // è¼‰å…¥æ¨¡å‹
        async function loadModel() {
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                
                console.log("è”¬æœè¾¨è­˜æ¨¡å‹è¼‰å…¥å®Œæˆï¼");
                document.getElementById("loadingStatus").innerHTML = "<p>âœ… AI æ¨¡å‹å·²è¼‰å…¥å®Œæˆï¼å¯ä»¥é–‹å§‹è¾¨è­˜ã€‚</p>";
            } catch (error) {
                console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—", error);
                document.getElementById("loadingStatus").innerHTML = "<p>âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–æ¨¡å‹è·¯å¾‘ã€‚</p>";
            }
        }

        // é–‹å§‹æ”åƒé ­è¾¨è­˜
        async function startWebcamDetection() {
            if (!model) {
                alert("AI æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆï¼");
                return;
            }
            
            if (!isWebcamDetecting) {
                try {
                    isWebcamDetecting = true;
                    document.getElementById('webcamResults').innerHTML = "ğŸ“¹ æ”åƒé ­è¾¨è­˜ä¸­...";
                    
                    const flip = true;
                    webcam = new tmImage.Webcam(300, 300, flip);
                    await webcam.setup();
                    await webcam.play();

                    document.getElementById("webcam-container").appendChild(webcam.canvas);
                    
                    webcamLoop();
                } catch (error) {
                    console.error("å•Ÿå‹•æ”åƒé ­å¤±æ•—", error);
                    alert("ç„¡æ³•å•Ÿå‹•æ”åƒé ­ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚");
                    isWebcamDetecting = false;
                }
            }
        }

        // æ”åƒé ­è¾¨è­˜å¾ªç’°
        async function webcamLoop() {
            if (!isWebcamDetecting) return;
            
            webcam.update();
            await predictWebcam();
            requestAnimationFrame(webcamLoop);
        }

        // æ”åƒé ­é æ¸¬
        async function predictWebcam() {
            const prediction = await model.predict(webcam.canvas);
            let maxPrediction = prediction.reduce((prev, curr) => 
                prev.probability > curr.probability ? prev : curr
            );
            
            updateResults('webcamResults', 'webcam-status', prediction, maxPrediction);
        }

        // åœæ­¢æ”åƒé ­è¾¨è­˜
        function stopWebcamDetection() {
            isWebcamDetecting = false;
            document.getElementById('webcamResults').innerHTML = "æ”åƒé ­è¾¨è­˜å·²åœæ­¢ã€‚";
            document.getElementById('webcam-status').className = 'status-indicator';
            
            if (webcam) {
                webcam.stop();
                const container = document.getElementById("webcam-container");
                if (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
            }
        }

        // æ›´æ–°è¾¨è­˜çµæœ
        function updateResults(resultId, statusId, predictions, maxPrediction) {
            const { className, probability } = maxPrediction;
            const confidence = (probability * 100).toFixed(1);
            
            // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
            const statusElement = document.getElementById(statusId);
            statusElement.className = 'status-indicator ' + getStatusClass(className);
            
            // æ’­æ”¾æç¤ºéŸ³ï¼ˆä¿¡å¿ƒåº¦90%ä»¥ä¸Šä¸”é"å…¶ä»–"é¡åˆ¥ï¼‰
            if (probability >= 0.9 && !fruitCategories.other.includes(className)) {
                playNotificationSound();
            }
            
            // æ›´æ–°çµæœé¡¯ç¤º
            let resultHTML = '<div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">';
            resultHTML += `ğŸ¯ ä¸»è¦è¾¨è­˜çµæœ: ${className} (${confidence}%)`;
            resultHTML += '</div>';
            
            resultHTML += '<div style="font-size: 14px;">';
            resultHTML += '<strong>æ‰€æœ‰è¾¨è­˜çµæœ:</strong><br>';
            
            predictions
                .sort((a, b) => b.probability - a.probability)
                .forEach(pred => {
                    const conf = (pred.probability * 100).toFixed(1);
                    let confClass = 'confidence-low';
                    if (pred.probability >= 0.9) confClass = 'confidence-high';
                    else if (pred.probability >= 0.5) confClass = 'confidence-medium';
                    
                    resultHTML += `<div class="result-item"><span class="${confClass}">${pred.className}: ${conf}%</span></div>`;
                });
            
            resultHTML += '</div>';
            document.getElementById(resultId).innerHTML = resultHTML;
            
            // å¦‚æœä¿¡å¿ƒåº¦è¶³å¤ é«˜ä¸”ä¸æ˜¯"å…¶ä»–"é¡åˆ¥ï¼Œè‡ªå‹•ç²å– AI å»ºè­°
            if (probability >= 0.7 && !fruitCategories.other.includes(className)) {
                // å»¶é²ä¸€ä¸‹å†èª¿ç”¨ï¼Œè®“ç”¨æˆ¶å…ˆçœ‹åˆ°è¾¨è­˜çµæœ
                setTimeout(() => {
                    getChatGPTAdvice(className, confidence);
                }, 1000);
            }
        }

        // åœ–ç‰‡ä¸Šå‚³ç›¸é—œ
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                displayImage(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                displayImage(file);
            }
        }

        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                analyzeBtn.disabled = false;
                // è‡ªå‹•åˆ†æåœ–ç‰‡
                setTimeout(() => {
                    analyzeUploadedImage();
                }, 100);
            };
            reader.readAsDataURL(file);
        }

        // åˆ†æä¸Šå‚³çš„åœ–ç‰‡
        async function analyzeUploadedImage() {
            if (!model) {
                alert("AI æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆï¼");
                return;
            }
            
            if (!imagePreview.src) {
                alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
                return;
            }
            
            try {
                document.getElementById('uploadResults').innerHTML = "ğŸ” åˆ†æä¸­...";
                const prediction = await model.predict(imagePreview);
                let maxPrediction = prediction.reduce((prev, curr) => 
                    prev.probability > curr.probability ? prev : curr
                );
                
                updateResults('uploadResults', 'upload-status', prediction, maxPrediction);
            } catch (error) {
                console.error("åœ–ç‰‡åˆ†æå¤±æ•—", error);
                document.getElementById('uploadResults').innerHTML = "âŒ åœ–ç‰‡åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚";
            }
        }

        // æ¸…é™¤åœ–ç‰‡
        function clearUploadedImage() {
            imagePreview.style.display = 'none';
            imagePreview.src = '';
            fileInput.value = '';
            analyzeBtn.disabled = true;
            document.getElementById('uploadResults').innerHTML = "åœ–ç‰‡è¾¨è­˜çµæœ: ç­‰å¾…ä¸Šå‚³...";
            document.getElementById('upload-status').className = 'status-indicator';
        }

        // ç¶å®šäº‹ä»¶
        document.getElementById('startWebcamBtn').onclick = startWebcamDetection;
        document.getElementById('stopWebcamBtn').onclick = stopWebcamDetection;
        document.getElementById('analyzeBtn').onclick = analyzeUploadedImage;
        document.getElementById('clearBtn').onclick = clearUploadedImage;

        // ç§»é™¤æ‹–æ‹½æ•ˆæœ
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        // è¼‰å…¥æ¨¡å‹
        loadModel();
        
        // åˆå§‹åŒ–æ¨¡å‹é¸æ“‡å™¨
        initializeModelSelector();
    </script>
</body>
</html>
